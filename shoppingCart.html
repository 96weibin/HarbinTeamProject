<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="../img/logo.png">
    <link rel="stylesheet" type="text/css" href="../css/init.css">
    <link rel="stylesheet" type="text/css" href="../css/index.css">
    <link rel="stylesheet" type="text/css" href="../css/shoppingCart.css">
    <title>shoppingCart</title>
</head>
<body>
    <div id="header">
        <div id="header_logo">
            <img src="../img/购物车.png" alt="" id="logo_img">
            <p>购物车</p>
        </div>
        <div id="search"></div>
    </div>
    <div id="title">
        <div id="title_top">
            <p id="allcommodity"></p>
           全部商品
        </div>
        <ul id="title_buttom">
       
            <li id="t_li1">商品详情</li>
            <li id="t_li2">数量</li>
            <li id="t_li3">单价</li>
            <li id="t_li4">金额</li>
            <li id="t_li5">操作</li>
            
        </ul>
    </div>
    <div id="shoppingList">
         
    </div>
    <div id="totalprices">
        <p>
       <span id="p1">总价
       </span>
        <span id="price">0</span>
        <button id="submitorder">提交订单</button>
    </p>
    </div>
</body>
<script src='../js/index.js'></script>
<script src="../js/myajax.js" charset="utf-8"></script>
<script>
    new Init_head();
    
    new Init_footer();
    var oTit = document.querySelector("#shoppingList");
    console.log(oTit);
    myajax.get("http://h6.duchengjiu.top/shop/api_cart.php",
            {token: localStorage.token},
            function(err,responseText){
                var json = JSON.parse(responseText);
                var data = json.data;
                for (var i=0; i< data.length; i++){
                    var obj = data[i];
                    obj.goods_sum = obj.goods_price* obj.goods_number;
                    oTit.innerHTML +=`
                    <ul id="sl_s">
                    <li id="sl_s_li1"><img src="${obj.goods_thumb}"><p>${obj.goods_name}</p></li>
                    <li id="sl_s_li2"><input data-id="${obj.goods_id}" type="number" name="number" min="1" max="10" value="${obj.goods_number}" /></li>
                    <li id="sl_s_li3">￥${obj.goods_price}</li>
                    <li id="sl_s_li4" name="sum">￥${obj.goods_sum}</li>
                    <li id="sl_s_li5"><input data-id="${obj.goods_id}" type="button" name="delete" value="删除"></li>
                    </ul>
                    `;
                }
               
                getSum();}
        )
     
      
    oTit.onchange = function(event){
            event = event || window.event;
            var target = event.target || event.srcElement;
            if(target.name === "number"){
                if(isNaN(parseInt(target.value))){
                    target.value = 1;
                }
                var goods_id = target.dataset.id;
                var number = target.value;
                myajax.post('http://h6.duchengjiu.top/shop/api_cart.php?token='+localStorage.token,
        {goods_id, number},
        function(err,responseText){
            var json = JSON.parse(responseText);
                if (json.code===0){
                 
                   
                    var goods_price = parseInt(target.parentNode.nextElementSibling.innerText);
                    target.parentNode.nextElementSibling.nextElementSibling.innerText = parseInt(target.value) * goods_price;
                    console.log(parseInt(target.value) * goods_price);
                }  
        })
    }
    getSum();
}

    oTit.addEventListener('click',function(event){
        event = event || window.event;
        var target = event.target || event.srcElement;
        if(target.name === "delete"){
            if(!confirm("确认删除吗？")){
                return;
            }
            var goods_id= target.dataset.id;
            var number = 0;
            myajax.post("http://h6.duchengjiu.top/shop/api_cart.php?token="+localStorage.token,
                {goods_id,number},
                (err,responseText) => {
                    var json = JSON.parse(responseText);
                    if(json.code === 0){
                        var ar = target.parentNode.parentNode;
                        ar.parentNode.removeChild(ar);
                    }
                }
        )
        }   getSum();
    }
 
);
    var oPirce = document.querySelector("#pirce");
    function getSum(){
        var oSums = document.querySelector("li[name=sum]");
        var sum=0;
        for(var i=0; i<oSums.length; i++){
            sum += parseInt (oSums[i].innerText.substr(1));
            console.log(sum);
        }
        localStorage.sum = sum;
        
    }
</script>
</html>